---
lab:
  title: 10 - Windows および Linux Virtual Machines に対する Microsoft Entra ID 認証
  learning path: '02'
  module: Module 02 - Implement an Authentication and Access Management Solution
---

# ラボ 10 - Windows および Linux Virtual Machines に対する Microsoft Entra 認証

### ログインの種類 = Azure リソース ログイン

## ラボのシナリオ

会社は、リモート アクセス用の仮想マシンへのログインに Microsoft Entra ID を使用することを決定しました。  このラボでは、Windows および Linux 仮想マシンに対してこれをセットアップする方法について示します。

#### 予想所要時間: 30 分

### 演習 1 - Microsoft Entra ID を使用して Azure の Windows Virtual Machines にログインする

#### タスク 1 - Microsoft Entra ID ログインを有効にして Windows 仮想マシンを作成する

1. [https://portal.azure.com](https://portal.azure.com) を参照します

1. **[+ リソースの作成]** を選択します。

1. [Marketplace を検索] 検索バーに「**Windows 11**」と入力して、**Enter** キーを押します。

1. **[Windows 11]** ボックスで、**[VM の作成]** を選択し、開いたメニューから **[Windows 11 Enterprise バージョン 22H2]** を選択します。

1. **[基本]** タブで次の値を使用して VM を作成します。

  | フィールド | 使用する値 |
  | :-- | :-- |
  | サブスクリプション | 既定値をそのまま使用します |
  | リソース グループ | 新規作成 - rgEntraLogin |
  | 仮想マシン名 | vmEntraLogin |
  | リージョン | *default* |
  | 可用性のオプション | インフラストラクチャ冗長は必要ありません |
  | 証券の種類 | Standard |
  | サイズ | Standard DC1s_v3 - 1 vCPU、8 GiB メモリ |
  | 管理ユーザー名 | vmEntraAdmin |
  | 管理者パスワード | ラボ環境から提供されるパスワードを使用するか、覚えておくことができる安全なパスワードを作成します |
  | ライセンス | ライセンスがあることを確認する |

1. **[ディスク]** または **[ネットワーク]** タブでは何も変更する必要はなく、値を確認できます。

1. **[管理]** タブで、[Microsoft Entra ID] セクションの **[Microsoft Entra ID でログイン]** のボックスをオンにします。

        NOTE: You will notice that the **System assigned managed identity** under the Identity section is automatically checked and turned grey. This action should happen automatically once you enable Login with Microsoft Entra ID.

1. 仮想マシンの作成エクスペリエンスの残りの部分に移動します。 

1. **[確認および作成]**、**[作成]** の順に選択します。

#### タスク 2 - 既存の Azure Virtual Machines に対して Microsoft Entra ID でログインする

1. [https://portal.azure.com](https://portal.azure.com) で **[Virtual Machines]** を参照します。

1. タスク 1 から新しく作成した仮想マシンを選びます。

1. **[アクセス制御 (IAM)]** を選択します。

1. **[+ 追加]** 、 **[ロールの割り当ての追加]** の順に選択して、[ロールの割り当ての追加] ページを開きます。

1. 次の設定を割り当てます。
  - **職務権限ロール**
  - **ロール**: 仮想マシンの管理者ログイン
  - **メンバー**: ユーザー、グループ、またはサービス プリンシパルを選びます。  その後、 **[+ メンバーの選択]** を使用して、**Joni Sherman** を VM の特定のユーザーとして追加します。

1. **[レビューと割り当て]** を選択して、プロセスを完了します。

#### タスク 3 - Microsoft Entra ID ログインを許可するように仮想マシンを更新する

1. **[接続]** メニュー項目を選択します。

1. **[RDP]** タブで、 **[RDP ファイルのダウンロード]** を選択します。  メッセージが表示されたら、ファイルの **[保持]** オプションを選びます。  ダウンロード フォルダーに保存されます。

1. ファイル マネージャーで **[ダウンロード]** フォルダーを開きます。

1. RDP を開きます。

1. 代替ユーザーとしてログインすることを選びます。

1. 仮想マシンの設定時に作成する管理者 (vmEntraAdmin) ユーザー名とパスワードを使用します。
   - メッセージが表示されたら、[はい] と答え、仮想マシンまたは RDP セッションへのアクセスを許可します。

1. 仮想マシンが開いてすべてのソフトウェアが読み込まれるのを待ちます。

1. 仮想マシンで **[スタート] ボタン**を選択します。

1. 「**コントロール パネル**」と入力し、コントロール パネル アプリを起動します。

1. 設定のリストから **[システムとセキュリティ]** を選択します。

1. **[システム]** 設定で、 **[リモート アクセスの許可]** オプションを選択します。

1. 開いたダイアログ ボックスの下部に、 **[リモート デスクトップ]** セクションが表示されます。

1. **[ネットワーク レベル認証でリモート デスクトップを実行しているコンピューターからのみ接続を許可する]** というラベルのチェックボックスを**オフ**にします。

1. **[Apply](適用)** 、 **[OK]** の順に選択します。

1. 仮想マシンの RDP セッションを**終了**します。

#### タスク 4 - Microsoft Entra ID ログインをサポートするように RDP ファイルを変更する

1. ファイル マネージャーで **[ダウンロード]** フォルダーを開きます。

1. RDP ファイルの**コピーを作成**し、ファイル名の末尾に **-EntraID** を追加します。

1. **メモ帳**を使用して、先ほどコピーした RDP ファイルの新しいバージョンを編集します。 これらの 2 行のテキストをファイルの下部に追加します。
     ```
        enablecredsspsupport:i:0
        authentication level:i:2
     ```
 
 1. RDP ファイルを**保存**します。  これで、次の 2 つのバージョンのファイルが表示されるはずです。
      - <<virtual machine name>>.RDP
      - <<virtual machine name>>-EntraID.RDP

#### タスク 5 - Microsoft Entra ID ログインを使って Windows 仮想マシンに接続する

1. **<<virtual machine name>>-EntraID.RDP を開きます

1. ダイアログが開いたら、 **[接続]** を選択します。

1. ログインに使用するユーザー アカウントの確認を求めるメッセージではなく、リモート コンピューターに接続するかどうかを確認するメッセージが表示されるはずです。

1. 画面の下部で、 **[はい]** を選択します。

1. リモート デスクトップ セッションが開くはずです。Windows Server ログイン画面が表示されます。  [OK] ボタンがある **[その他のユーザー]** が表示されるはずです。

1. **[OK]** を選択します。

1. ログイン ダイアログで、次の情報を入力します。
   - ユーザー名 = **AzureAD\JoniS@ your domain name**
   - パスワード = ラボ プロバイダーによって提供されるパスワードを入力します

   注: JoniS は、タスク 1 で管理者としてログインするアクセス権を付与したユーザーです。

1. Windows Server でログインが確認され、通常のサーバー マネージャー ダッシュボードが開くはずです。

#### タスク 6 -- Microsoft Entra ID ログインを確認するための省略可能なテスト

1. JoniS が Administrators グループに追加された唯一のユーザーであることを確認します。

1. [スタート] ボタンを右クリックし、ポップアップ メニューで **[コンピューターの管理]** を選びます。

1. **[ローカル ユーザーとグループ]** を開いてから、 **[グループ]、[Administrators]** の順に移動します。

1. リストに **[Azure\JoniSherman....]** が表示されるはずです。

1. 他の Microsoft Entra ID メンバーがログインできるかどうかを確認します。

1. リモート デスクトップ セッションを終了します。

1. **<<server name>>-AzureAD.RDP** ファイルをもう一度起動します。

1. AdeleV、AlexW、DiegoS などの他の Azure AD メンバーとしてログインしてみます。

1. これらの各ユーザーのアクセスが拒否されていることがわかるはずです。

### 省略可能な演習 2 - Microsoft Entra ID を使用して Azure の Linux Virtual Machines にログインする

#### タスク 1 - システム割り当てマネージド ID を使用して Linux VM を作成する

1. [https://portal.azure.com](https://portal.azure.com) を参照します

1. **[+ リソースの作成]** を選択します。

1. 「**Ubuntu**」を検索します。

1. **[Ubuntu Server 22.04 LTS]** の **[作成]** を選びます。 このテスト ラボには他の Linux サーバーを使うこともできます。

1. **[管理]** タブで、チェックボックスをオンにして、**[Microsoft Entra ID でログインする]** を有効にします。

1. **システム割り当てマネージド ID** がオンにされていることを確認します。

1. 仮想マシンの作成エクスペリエンスの残りの部分に移動します。 このプレビュー期間中は、ユーザー名とパスワードまたは SSH 公開キーで管理者アカウントを作成する必要があります。

#### タスク 2 - 既存の Azure Virtual Machines に対して Microsoft Entra ID でログインする

1. [https://portal.azure.com](https://portal.azure.com) で **[Virtual Machines]** を参照します。

1. **[アクセス制御 (IAM)]** を選択します。

1. [追加] > [ロール割り当ての追加] を選択して、[ロール割り当ての追加] ページを開きます。

1. 次のロールを割り当てます。 
    - **ロール**:仮想マシンの管理者ログインまたは仮想マシンのユーザー ログイン
    - **アクセスの割り当て先**:ユーザー、グループ、サービス プリンシパル、またはマネージド ID

1. 詳細な手順については、「Azure portal を使用して Azure ロールを割り当てる」を参照してください。
